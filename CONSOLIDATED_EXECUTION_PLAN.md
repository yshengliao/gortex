-- Gortex 框架演進執行計畫

## 核心目標

將 Gortex 從一個依賴 Echo v4 的框架，演進為一個具備獨立路由與協定處理能力的框架。最終目標是讓開發者能專注於撰寫純粹的業務邏輯，而所有 HTTP/WebSocket 的細節都由框架自動處理，並保持對現有 Echo API 的完全向後相容性。

## 成功指標

- **開發效率**: 5 分鐘內完成一個新 API 的開發。
- **程式碼精簡**: 減少 80% 的 HTTP 處理樣板程式碼。
- **路由效能**: 提升 20-40% 的路由查找效能。
- **依賴減少**: 移除 Echo v4 核心依賴，減少 25-33% 的三方套件。
- **執行檔大小**: 縮減 30-40%。

---

## 執行藍圖 (Roadmap)

此藍圖將大型任務拆分為更小、適合單一 commit 的工作項目，並按優先順序排列。

### Phase 1: 核心路由功能強化 (Foundational Router Enhancements)

**目標**: 完善自訂路由器的功能，使其完全支援 RESTful API 所需的動態路由與分組功能。

- **[x] 任務 1.1: 實現動態參數路由 (`:param`)**
  - 在路由樹 (radix tree) 的查找演算法中增加對 `/:param` 語法的解析與匹配。
  - 在 `Context` 中增加 `Param(key string) string` 方法來提取路徑參數。
  - 撰寫針對性的單元測試與效能基準測試。

- **[x] 任務 1.2: 實現萬用字元路由 (`*wildcard`)**
  - 在路由樹中增加對 `/*filepath` 語法的支援。
  - 確保萬用字元路由的優先級低於靜態和動態參數路由。
  - 撰寫相關單元測試。

- **[x] 任務 1.3: 實現巢狀 Handler 分組與路由前綴**
  - 讓 `HandlersManager` 可以巢狀包含其他的 Handler 結構。
  - 路由註冊時，根據巢狀結構自動為子路由添加父結構的 `url` 標籤作為前綴。
  - 例如: `APIv1Group` (`url:"/api/v1"`) 包含 `GameHandler` (`url:"/:gameid"`) -> `/api/v1/:gameid`。
  - 撰寫針對巢狀路由的單元測試。

- **[x] 任務 1.4: 為 Handler 分組實現中間件繼承**
  - 設計一種機制，允許在 Handler Group 上定義中間件，並讓其所有子路由自動繼承。
  - 確保中間件的執行順序正確（父級 -> 子級）。
  - 撰寫中間件繼承功能的整合測試。

### Phase 2: 自動化 Handler 層 (Automated Handler Layer)

**目標**: 建立一個從純業務邏輯方法到 HTTP Handler 的自動化轉換層，徹底消除手寫 HTTP 處理樣板程式碼。

- **[x] 任務 2.1: 設計並實現參數綁定引擎**
  - 使用 `reflect` 建立一個 `ParameterBinder`，能夠檢查業務邏輯方法的簽名。
  - 實現從多個來源（路徑參數、查詢參數、請求體 JSON）自動綁定參數到方法輸入。
  - 建立命名慣例或自訂標籤來輔助綁定（例如，`json:"name"`）。

- **[x] 任務 2.2: 擴展參數綁定引擎功能**
  - 增加對更多參數來源的支援：請求標頭 (Request Headers)、JWT Claims、以及透過 DI 容器注入的服務。
  - 整合 `validator` 套件，在綁定後自動執行結構體驗證。

- **[x] 任務 2.3: 建立程式碼產生器 CLI (`gortex-gen`)**
  - 建立 `gortex-gen` CLI 工具的基本骨架。
  - 實現一個 AST 解析器，用於掃描專案中的 Go 原始碼，並找出標記了 `//go:generate gortex-gen handler` 的業務邏輯方法。

- **[x] 任務 2.4: 實現 Handler 程式碼產生**
  - 建立 Go template，用於產生 HTTP Handler 的樣板程式碼。
  - 產生的程式碼應包含：呼叫參數綁定引擎、呼叫原始業務邏輯方法、處理回傳值與錯誤。

- **[x] 任務 2.5: 建立業務錯誤碼與 HTTP 狀態碼的映射機制**
  - 設計一個全域的錯誤映射註冊表，允許開發者定義業務錯誤（例如 `ErrGameNotFound`）與 HTTP 錯誤（`{404, "GAME_NOT_FOUND"}`）之間的對應關係。
  - 實現一個錯誤處理中介，能自動查詢此註冊表並回傳標準化的錯誤 JSON。

- **[ ] 任務 2.6: 將錯誤與回應處理整合至程式碼產生器**
  - 在 Handler template 中整合錯誤映射機制，當業務方法回傳錯誤時，自動轉換為標準的 HTTP 回應。
  - 同樣地，將成功的回應（業務方法的回傳值）自動封裝成標準的成功 JSON 回應。

### Phase 3: 遷移與相容性 (Migration & Compatibility)

**目標**: 提供工具與流程，確保現有基於 Echo 的專案能平滑、安全地遷移到新的架構。

- **[ ] 任務 3.1: 實現 A/B 測試框架**
  - 建立一個可以在 `Dual` 模式下運行的測試執行器。
  - 該執行器會將收到的請求同時發送到 Echo 路由和 Gortex 路由。
  - 比較兩者的回應（狀態碼、標頭、回應體），並記錄差異，以驗證相容性。

- **[ ] 任務 3.2: 開發遷移分析工具**
  - 在 `gortex-cli` 中增加 `migrate check` 子命令。
  - 此工具會掃描專案，找出所有舊式的 Echo Handlers，並提供遷移到新業務邏輯服務模式的建議。

- **[ ] 任務 3.3: 更新所有範例專案**
  - 將 `/examples` 目錄下的 `simple`, `websocket`, `auth` 專案完全重構，使用新的服務導向、程式碼產生的開發模式。
  - 確保範例專案是新架構的最佳實踐典範。

### Phase 4: 最終化與優化 (Finalization & Optimization)

**目標**: 完善文件，進行效能調優，並清理不再需要的依賴，完成框架的演進。

- **[x] 任務 4.1: 撰寫完整的文件**
  - 撰寫一份詳細的遷移指南，指導使用者如何從舊版本遷移。
  - 更新 API Reference，詳細說明新的服務與程式碼產生器用法。
  - 建立新的 "Troubleshooting" 章節，解決常見問題。

- **[x] 任務 4.2: 效能剖析與調優**
  - 對新的路由系統、參數綁定引擎進行全面的效能基準測試與剖析 (profiling)。
  - 根據剖析結果，對熱點路徑 (hot paths) 進行優化，例如使用物件池 (`sync.Pool`) 減少記憶體分配。

- **[ ] 任務 4.3: 移除 Echo 核心依賴**
  - 在所有內部套件中，將 `echo.Context` 替換為 Gortex 自訂的 `Context` 介面。
  - 移除 `go.mod` 中對 `github.com/labstack/echo/v4` 的直接依賴。
  - 確保所有測試都通過，並且 A/B 測試框架顯示行為一致。

- **[ ] 任務 4.4: 最終化與發布**
  - 更新 `README.md` 和 `CLAUDE.md` 以反映新的架構和用法。
  - 標記一個新的 major/minor 版本號。
  - 撰寫發布日誌 (Release Notes)，總結所有重大變更。
